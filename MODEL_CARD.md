# Model Card — Used Car Price Regressor

## 1. Назначение модели

Модель решает задачу регрессии: по характеристикам подержанного автомобиля предсказывается его цену (в долларах США).

Применение: оценка ориентировочной рыночной стоимости авто, аналитика объявлений, учебный пример MLOps-пайплайна.

---

## 2. Исходные данные

Датасет: Used Car Price Prediction Dataset (Kaggle)  
Ссылка: https://www.kaggle.com/datasets/taeefnajib/used-car-price-prediction-dataset?utm_source=chatgpt.com  

Основные поля:

- `brand`, `model`
- `model_year`
- `milage` (строка вида `"51,000 mi."`)
- `fuel_type`
- `engine` (описание двигателя)
- `transmission`
- `ext_col`, `int_col`
- `accident`, `clean_title`
- `price` (строка вида `"$10,300"`)

Целевая переменная в модели: `price_num` (числовая цена после предобработки).

---

## 3. Архитектура модели

Используется классический стек `scikit-learn`:

- `ColumnTransformer`:
  - числовые признаки (например, `model_year`, `milage_num`, `engine_hp`, `engine_liters`) — без изменений;
  - категориальные признаки (`brand`, `model`, `fuel_type`, `engine` и др.) — `OneHotEncoder(handle_unknown="ignore", sparse_output=False)`.
- Модель: `RandomForestRegressor`.

Основной рабочий вариант (v2):

- `n_estimators = 200`
- `max_depth = None`
- `random_state = 42`
- `n_jobs = -1`

Модель упакована в `sklearn.Pipeline` и сохраняется в файл:
`artifacts/models/model_v2.joblib`.

---

## 4. Метрики

На лучшем эксперименте (RandomForest + препроцессинг v2):

| Датасет | MAE (доллары) | RMSE (доллары) | R²     |
|---------|---------------|----------------|--------|
| Train   | 2495.94       | 4515.26        | 0.9796 |
| Test    | 6147.79       | 10439.42       | 0.8685 |

Интерпретация:

- MAE на тесте ≈ 6148 долларов — средняя абсолютная ошибка по цене.
- RMSE ≈ 10439 долларов — подчёркивает наличие отдельных крупных ошибок.
- R² ≈ 0.87 — модель объясняет около 87 % вариации цен на тестовой выборке.
---

## 5. Версионирование и эксперименты

Используется **MLflow**.

Основные эксперименты:

- `rf_v1_baseline` — базовый препроцессинг v1;
- `rf_v1_tuned_depth12` — тот же препроцессинг v1, изменены гиперпараметры RandomForest;
- `rf_v2_engine_features` — препроцессинг v2 (извлечение `engine_hp` и `engine_liters` из `engine`).

Версионирование:

- минимум 3 запуска (runs) в одном MLflow-эксперименте `used_cars_price`;
- минимум 2 версии препроцессинга: `v1` и `v2`.

В MLflow логируются:

- параметры данных и препроцессинга;
- гиперпараметры модели;
- метрики (MAE, RMSE, R²);
- артефакт с моделью (через `mlflow.sklearn.log_model`).

---

## 6. Ограничения

- Модель обучена на конкретном датасете объявлений; перенос на другие рынки/страны без дообучения может ухудшить качество.
- Не учитываются важные факторы: реальное техническое состояние, сезон, спрос/предложение.
- Модель — классический ансамбль деревьев, без учёта временной динамики рынка и без сложных текстовых эмбеддингов.

Рекомендация: использовать модель как инструмент приблизительной оценки, а не как единственный источник истины.

---

## 7. Инференс

Модель используется FastAPI-сервисом:

- `GET /health` — проверка работоспособности сервиса;
- `POST /predict` — прием JSON с описаниями автомобилей и возврат предсказанных цен;
- `GET /docs` — Swagger UI с описанием схем запросов/ответов.

Формат запроса к `/predict`:

- поле `objects` — список объектов с полями, аналогичными исходному датасету (`brand`, `model_year`, `milage`, `engine` и т.д.);
- внутри сервиса выполняется тот же препроцессинг, что и при обучении (v2), после чего вызывается сохранённый `sklearn.Pipeline`.